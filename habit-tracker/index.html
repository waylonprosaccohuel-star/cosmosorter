<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‚²å„¿æ‰“å¡ Â· æ–°æ‰‹å¦ˆå¦ˆ</title>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #FFECE3;
      --bg-light:  #FFF5F0;
      --surface:   #ffffff;
      --surface2:  #FFF9F6;
      --border:    #FFD4C2;
      --primary:   #E8735A;
      --primary-m: #F4956E;
      --primary-l: #FFECE3;
      --primary-d: #C95A42;
      --success:   #52B788;
      --success-l: #D8F3DC;
      --warn:      #F4A261;
      --warn-l:    #FDE8D0;
      --text:      #3D2314;
      --text-2:    #8B5E52;
      --text-3:    #C4A49C;
      --radius:    16px;
      --radius-sm: 10px;
      --shadow:    0 2px 16px rgba(232,115,90,.10);
      --shadow-md: 0 4px 24px rgba(232,115,90,.14);
    }

    body {
      font-family: "PingFang SC", "Microsoft YaHei", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* ===== Header ===== */
    .app-header {
      background: var(--surface);
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(232,115,90,.10);
      border-bottom: 2px solid var(--border);
    }
    .app-header-inner {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
    }
    .app-header-left {}
    .app-header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: .3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .app-header .date-line {
      font-size: .8rem;
      color: var(--text-2);
      margin-top: 3px;
    }
    .header-badge {
      background: var(--primary-l);
      color: var(--primary);
      font-size: .75rem;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 99px;
      border: 1.5px solid var(--border);
    }

    /* ===== Layout ===== */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* ===== Section Title ===== */
    .section-title {
      font-size: .78rem;
      font-weight: 700;
      color: var(--text-3);
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 0 4px;
      margin-bottom: -6px;
    }

    /* ===== Card ===== */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid rgba(255,212,194,.6);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 14px;
      border-bottom: 1px solid var(--border);
    }
    .card-header h2 {
      font-size: .98rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }
    .card-header h2 .icon-wrap {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: var(--primary-l);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .card-body { padding: 16px 20px; }

    /* ===== Today Progress Ring ===== */
    .today-header-extra {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .progress-ring-wrap {
      position: relative;
      width: 44px;
      height: 44px;
    }
    .progress-ring-wrap svg {
      transform: rotate(-90deg);
    }
    .progress-ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .65rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* ===== Habit Item ===== */
    .habit-list { display: flex; flex-direction: column; gap: 10px; }

    .habit-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 14px;
      border-radius: var(--radius-sm);
      background: var(--surface2);
      border: 1.5px solid var(--border);
      transition: border-color .2s, background .2s, transform .12s, box-shadow .2s;
      cursor: pointer;
      user-select: none;
    }
    .habit-item:hover {
      border-color: var(--primary-m);
      box-shadow: 0 2px 10px rgba(232,115,90,.12);
      transform: translateY(-1px);
    }
    .habit-item:active { transform: scale(.98); }
    .habit-item.checked {
      background: var(--success-l);
      border-color: var(--success);
    }
    .habit-item.checked .habit-name {
      text-decoration: line-through;
      color: var(--text-2);
    }

    .check-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background .2s, border-color .2s;
      font-size: 13px;
      background: var(--surface);
    }
    .habit-item.checked .check-circle {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .habit-icon-wrap {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      flex-shrink: 0;
      background: var(--primary-l);
    }
    .habit-item.checked .habit-icon-wrap {
      background: rgba(82,183,136,.15);
    }

    .habit-info { flex: 1; min-width: 0; }
    .habit-name { font-size: .92rem; font-weight: 600; color: var(--text); }
    .habit-desc {
      font-size: .76rem;
      color: var(--text-2);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .habit-tag {
      font-size: .68rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 99px;
      background: var(--primary-l);
      color: var(--primary);
      flex-shrink: 0;
    }
    .habit-item.checked .habit-tag {
      background: rgba(82,183,136,.2);
      color: var(--success);
    }

    .habit-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px 7px;
      border-radius: 8px;
      font-size: .95rem;
      color: var(--text-3);
      transition: background .15s, color .15s;
    }
    .btn-icon:hover { background: var(--primary-l); color: var(--primary); }
    .btn-icon.danger:hover { background: #fee2e2; color: #ef4444; }

    /* ===== Empty State ===== */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-3);
    }
    .empty-state .emoji { font-size: 2.5rem; margin-bottom: 10px; }
    .empty-state p { font-size: .88rem; line-height: 1.6; }

    /* ===== Add Habit Form ===== */
    .add-form { display: flex; flex-direction: column; gap: 14px; }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label {
      font-size: .78rem;
      font-weight: 600;
      color: var(--text-2);
      letter-spacing: .3px;
    }

    .form-input, .form-select {
      padding: 10px 13px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: .9rem;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      transition: border-color .2s, box-shadow .2s;
      width: 100%;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(232,115,90,.12);
    }
    .form-input::placeholder { color: var(--text-3); }

    .icon-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }
    .icon-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--surface2);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color .15s, background .15s, transform .1s;
    }
    .icon-btn:hover { transform: scale(1.1); border-color: var(--primary-m); }
    .icon-btn.selected {
      border-color: var(--primary);
      background: var(--primary-l);
      transform: scale(1.08);
    }

    .color-picker { display: flex; gap: 9px; flex-wrap: wrap; }
    .color-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: transform .15s, border-color .15s;
    }
    .color-dot:hover { transform: scale(1.18); }
    .color-dot.selected { border-color: var(--text); transform: scale(1.12); }

    /* ===== Buttons ===== */
    .btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: .88rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s, transform .1s, box-shadow .15s;
      font-family: inherit;
      letter-spacing: .2px;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px rgba(232,115,90,.3);
    }
    .btn-primary:hover { background: var(--primary-d); box-shadow: 0 4px 12px rgba(232,115,90,.4); }
    .btn-outline {
      background: transparent;
      border: 1.5px solid var(--border);
      color: var(--text-2);
    }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-sm { padding: 7px 14px; font-size: .8rem; }

    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 4px; }

    /* ===== Weekly Stats ===== */
    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 20px;
    }
    .week-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .week-day-label {
      font-size: .68rem;
      color: var(--text-3);
      font-weight: 600;
    }
    .week-day-dot {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--bg-light);
      border: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
      font-weight: 600;
      color: var(--text-3);
      transition: background .2s, color .2s, border-color .2s;
    }
    .week-day-dot.today {
      border: 2px solid var(--primary);
      color: var(--primary);
      background: var(--primary-l);
    }
    .week-day-dot.full {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }
    .week-day-dot.partial {
      background: var(--warn-l);
      border-color: var(--warn);
      color: #92400e;
    }
    .week-day-dot.future { opacity: .4; }

    /* ===== Summary Banner ===== */
    .summary-banner {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--primary-l) 0%, #fff5f0 100%);
      border-radius: var(--radius-sm);
      margin-bottom: 18px;
      border: 1px solid var(--border);
    }
    .summary-emoji { font-size: 2.2rem; flex-shrink: 0; }
    .summary-text h3 { font-size: .92rem; font-weight: 700; color: var(--primary-d); }
    .summary-text p { font-size: .78rem; color: var(--text-2); margin-top: 3px; }

    /* ===== Progress Bars ===== */
    .habit-stats { display: flex; flex-direction: column; gap: 14px; }
    .stat-row { display: flex; flex-direction: column; gap: 7px; }
    .stat-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-habit-name {
      font-size: .86rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 7px;
      color: var(--text);
    }
    .stat-pct {
      font-size: .8rem;
      font-weight: 700;
      color: var(--text-2);
    }
    .progress-track {
      height: 7px;
      background: var(--bg);
      border-radius: 99px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 99px;
      background: var(--primary);
      transition: width .6s cubic-bezier(.4,0,.2,1);
    }
    .progress-fill.full { background: var(--success); }

    /* ===== Tip Banner ===== */
    .tip-banner {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #fff9f0 0%, #fff5f0 100%);
      border-radius: var(--radius-sm);
      border: 1px solid #FFD4C2;
    }
    .tip-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 1px; }
    .tip-content h4 { font-size: .85rem; font-weight: 700; color: var(--primary-d); margin-bottom: 4px; }
    .tip-content p { font-size: .78rem; color: var(--text-2); line-height: 1.6; }

    /* ===== Category Divider ===== */
    .category-label {
      font-size: .72rem;
      font-weight: 700;
      color: var(--text-3);
      letter-spacing: .8px;
      padding: 4px 2px 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .category-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ===== Toast ===== */
    #toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--text);
      color: #fff;
      padding: 11px 22px;
      border-radius: 99px;
      font-size: .86rem;
      font-weight: 500;
      z-index: 9999;
      transition: transform .3s cubic-bezier(.4,0,.2,1), opacity .3s;
      opacity: 0;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 4px 20px rgba(61,35,20,.25);
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* ===== Divider ===== */
    .add-form-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0 8px;
    }

    /* ===== Responsive ===== */
    @media (max-width: 400px) {
      .form-row { flex-direction: column; }
      .week-day-dot { width: 28px; height: 28px; font-size: .68rem; }
      .app-header-inner { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>

<!-- ===== Header ===== -->
<header class="app-header">
  <div class="app-header-inner">
    <div class="app-header-left">
      <h1>ğŸŒ¸ è‚²å„¿æ‰“å¡</h1>
      <div class="date-line" id="header-date"></div>
    </div>
    <div class="header-badge" id="header-badge">ğŸ‘¶ 0~1å²</div>
  </div>
</header>

<div class="container">

  <!-- ===== Today Tip ===== -->
  <div class="tip-banner" id="daily-tip">
    <div class="tip-icon">ğŸ’¡</div>
    <div class="tip-content">
      <h4>ä»Šæ—¥è‚²å„¿å°è´´å£«</h4>
      <p id="tip-text">åŠ è½½ä¸­â€¦</p>
    </div>
  </div>

  <!-- ===== Today's Check-in ===== -->
  <div class="card" id="today-card">
    <div class="card-header">
      <h2>
        <span class="icon-wrap">ğŸ“‹</span>
        ä»Šæ—¥æ‰“å¡
      </h2>
      <div class="today-header-extra">
        <span id="today-progress-text" style="font-size:.8rem;color:var(--text-2);font-weight:600;"></span>
        <div class="progress-ring-wrap">
          <svg width="44" height="44" viewBox="0 0 44 44">
            <circle cx="22" cy="22" r="17" fill="none" stroke="#FFD4C2" stroke-width="4"/>
            <circle id="ring-fill" cx="22" cy="22" r="17" fill="none"
                    stroke="#E8735A" stroke-width="4"
                    stroke-dasharray="106.8" stroke-dashoffset="106.8"
                    stroke-linecap="round"
                    style="transition: stroke-dashoffset .6s cubic-bezier(.4,0,.2,1)"/>
          </svg>
          <div class="progress-ring-center" id="ring-pct">0%</div>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="habit-list" id="today-habit-list">
        <!-- rendered by JS -->
      </div>
    </div>
  </div>

  <!-- ===== Weekly Stats ===== -->
  <div class="card">
    <div class="card-header">
      <h2>
        <span class="icon-wrap">ğŸ“Š</span>
        æœ¬å‘¨ç»Ÿè®¡
      </h2>
    </div>
    <div class="card-body">
      <div class="summary-banner" id="week-summary-banner">
        <div class="summary-emoji" id="week-emoji">ğŸŒ±</div>
        <div class="summary-text">
          <h3 id="week-summary-title">åŠ è½½ä¸­â€¦</h3>
          <p id="week-summary-sub"></p>
        </div>
      </div>
      <div class="week-grid" id="week-grid"></div>
      <div class="habit-stats" id="habit-stats"></div>
    </div>
  </div>

  <!-- ===== Habit Management ===== -->
  <div class="card">
    <div class="card-header">
      <h2>
        <span class="icon-wrap">âš™ï¸</span>
        ä¹ æƒ¯ç®¡ç†
      </h2>
      <button class="btn btn-primary btn-sm" id="toggle-add-btn" onclick="toggleAddForm()">
        <span id="toggle-add-icon">ï¼‹</span>&nbsp;æ·»åŠ ä¹ æƒ¯
      </button>
    </div>
    <div class="card-body">

      <!-- Add Form (hidden by default) -->
      <div id="add-form-wrap" style="display:none; margin-bottom:20px;">
        <div class="add-form">
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label>ä¹ æƒ¯åç§° *</label>
              <input class="form-input" id="f-name" type="text" placeholder="ä¾‹ï¼šå–‚å¥¶ã€å®å®æ´—æ¾¡â€¦" maxlength="20" />
            </div>
          </div>
          <div class="form-group">
            <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
            <input class="form-input" id="f-desc" type="text" placeholder="ç®€çŸ­è¯´æ˜ï¼Œå¸®åŠ©è®°å¿†" maxlength="40" />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©å›¾æ ‡</label>
            <div class="icon-picker" id="icon-picker"></div>
          </div>
          <div class="form-group">
            <label>é€‰æ‹©é¢œè‰²</label>
            <div class="color-picker" id="color-picker"></div>
          </div>
          <div class="add-form-divider"></div>
          <div class="form-actions">
            <button class="btn btn-outline btn-sm" onclick="cancelAddForm()">å–æ¶ˆ</button>
            <button class="btn btn-primary btn-sm" onclick="saveHabit()">âœ“ ä¿å­˜ä¹ æƒ¯</button>
          </div>
        </div>
      </div>

      <!-- Habit Management List -->
      <div class="habit-list" id="manage-habit-list">
        <!-- rendered by JS -->
      </div>
    </div>
  </div>

</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ============================================================
   Constants & Config
   ============================================================ */
const STORAGE_HABITS = 'ht_habits_v2';
const STORAGE_PREFIX = 'ht_rec_';

const ICONS = [
  'ğŸ¼','ğŸ¤±','ğŸ‘¶','ğŸ›','ğŸ§·','ğŸ˜´','ğŸŒ™','ğŸŒ…','ğŸ’§','ğŸ¥›',
  'ğŸŒ¿','ğŸš¶','ğŸµ','ğŸ—£ï¸','ğŸ“¸','ğŸ§¸','ğŸ’Š','ğŸŒ¸','â¤ï¸','ğŸ“',
  'ğŸ','ğŸ§˜','ğŸŒˆ','ğŸ’•','ğŸ¯','ğŸŒº','ğŸƒ','âœï¸','ğŸ§ ','ğŸ¶'
];
const COLORS = [
  '#E8735A','#F4A261','#52B788','#4ECDC4','#45B7D1',
  '#96CEB4','#FFEAA7','#DDA0DD','#98D8C8','#F7DC6F'
];

const DAY_LABELS = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

const TIPS = [
  '0~3ä¸ªæœˆå®å®æ¯å¤©éœ€è¦ç¡14~17å°æ—¶ï¼Œç™½å¤©å°ç¡å¾ˆæ­£å¸¸ï¼Œå¦ˆå¦ˆä¹Ÿè¦è¶æœºä¼‘æ¯å“¦ï½',
  'æ¯ä¹³å–‚å…»æ—¶å¦ˆå¦ˆæ¯å¤©éœ€è¦é¢å¤–è¡¥å……çº¦500å¤§å¡ï¼Œå¤šå–æ±¤æ°´æœ‰åŠ©äºæ³Œä¹³ã€‚',
  'å®å®å“­æ³£ä¸ä¸€å®šæ˜¯é¥¿äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯éœ€è¦å®‰æŠšã€æ¢å°¿å¸ƒæˆ–åªæ˜¯æƒ³è¢«æŠ±æŠ±ã€‚',
  'æ¯å¤©ç»™å®å®åš10åˆ†é’ŸæŠšè§¦æŒ‰æ‘©ï¼Œæœ‰åŠ©äºä¿ƒè¿›ç¥ç»å‘è‚²å’Œäº²å­æƒ…æ„Ÿè¿æ¥ã€‚',
  '4~6ä¸ªæœˆå®å®å¼€å§‹å¯¹å‘¨å›´äº‹ç‰©æ„Ÿå…´è¶£ï¼Œå¤šå’Œå®å®è¯´è¯ã€å”±æ­Œï¼Œåˆºæ¿€è¯­è¨€å‘è‚²ã€‚',
  'å®å®çš„ç¬¬ä¸€æ¬¡å¾®ç¬‘é€šå¸¸åœ¨6~8å‘¨å‡ºç°ï¼Œè¿™æ˜¯ç¤¾äº¤æ€§å¾®ç¬‘ï¼Œæ˜¯é‡è¦çš„å‘è‚²é‡Œç¨‹ç¢‘ï¼',
  'æ–°æ‰‹å¦ˆå¦ˆè¦ç…§é¡¾å¥½è‡ªå·±ï¼Œæ‰èƒ½æ›´å¥½åœ°ç…§é¡¾å®å®ã€‚é€‚å½“ä¼‘æ¯ä¸æ˜¯è‡ªç§ï¼Œæ˜¯å¿…è¦çš„ã€‚',
  'å®å®æ´—æ¾¡æ°´æ¸©å»ºè®®37~38â„ƒï¼Œç”¨æ‰‹è‚˜æµ‹è¯•æœ€å‡†ç¡®ï¼Œæ¯æ¬¡5~10åˆ†é’Ÿå³å¯ã€‚',
  '6ä¸ªæœˆåå¯ä»¥å¼€å§‹æ·»åŠ è¾…é£Ÿï¼Œä»å•ä¸€é£Ÿæå¼€å§‹ï¼Œæ¯æ¬¡åªå¼•å…¥ä¸€ç§æ–°é£Ÿç‰©ã€‚',
  'å®å®çš„è§†åŠ›åœ¨å‡ºç”Ÿæ—¶åªæœ‰0.05å·¦å³ï¼Œå–œæ¬¢çœ‹é«˜å¯¹æ¯”åº¦çš„å›¾æ¡ˆå’Œå¦ˆå¦ˆçš„è„¸ã€‚',
];

/* ============================================================
   State
   ============================================================ */
let habits = [];
let selectedIcon  = ICONS[0];
let selectedColor = COLORS[0];

/* ============================================================
   Storage Helpers
   ============================================================ */
function loadHabits() {
  try {
    const raw = localStorage.getItem(STORAGE_HABITS);
    habits = raw ? JSON.parse(raw) : [];
  } catch { habits = []; }
}

function saveHabits() {
  localStorage.setItem(STORAGE_HABITS, JSON.stringify(habits));
}

function getMonthKey(dateStr) { return dateStr.slice(0, 7); }

function loadMonthRecords(monthKey) {
  try {
    const raw = localStorage.getItem(STORAGE_PREFIX + monthKey);
    return raw ? JSON.parse(raw) : { records: {} };
  } catch { return { records: {} }; }
}

function saveMonthRecords(monthKey, data) {
  localStorage.setItem(STORAGE_PREFIX + monthKey, JSON.stringify(data));
}

/* ============================================================
   Date Helpers
   ============================================================ */
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function dateStrFromDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function getWeekDates() {
  const today = new Date();
  const dow = today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate() - ((dow + 6) % 7));
  return Array.from({ length: 7 }, (_, i) => {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    return dateStrFromDate(d);
  });
}

/* ============================================================
   Check-in Logic
   ============================================================ */
function isChecked(dateStr, habitId) {
  const mk = getMonthKey(dateStr);
  const data = loadMonthRecords(mk);
  return !!(data.records[dateStr] && data.records[dateStr][habitId] && data.records[dateStr][habitId].checked);
}

function toggleCheck(dateStr, habitId) {
  const mk = getMonthKey(dateStr);
  const data = loadMonthRecords(mk);
  if (!data.records[dateStr]) data.records[dateStr] = {};
  const cur = data.records[dateStr][habitId];
  if (cur && cur.checked) {
    data.records[dateStr][habitId] = { checked: false, checkedAt: null, note: '' };
  } else {
    data.records[dateStr][habitId] = { checked: true, checkedAt: new Date().toISOString(), note: '' };
  }
  saveMonthRecords(mk, data);
}

/* ============================================================
   Render: Today's Habit List
   ============================================================ */
function renderToday() {
  const today = todayStr();
  const activeHabits = habits.filter(h => !h.archivedAt);
  const list = document.getElementById('today-habit-list');
  const progressText = document.getElementById('today-progress-text');

  if (activeHabits.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="emoji">ğŸŒ¸</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡é¡¹ç›®<br>å»ä¸‹æ–¹æ·»åŠ ç¬¬ä¸€ä¸ªè‚²å„¿ä¹ æƒ¯å§ï¼</p>
      </div>`;
    progressText.textContent = '';
    updateRing(0, 0);
    return;
  }

  let checkedCount = 0;
  list.innerHTML = activeHabits.map(h => {
    const checked = isChecked(today, h.id);
    if (checked) checkedCount++;
    return `
      <div class="habit-item ${checked ? 'checked' : ''}" onclick="handleCheck('${h.id}')" id="hi-${h.id}">
        <div class="check-circle">${checked ? 'âœ“' : ''}</div>
        <div class="habit-icon-wrap" style="background:${checked ? 'rgba(82,183,136,.15)' : hexToRgba(h.color, .15)}">${h.icon}</div>
        <div class="habit-info">
          <div class="habit-name">${escHtml(h.name)}</div>
          ${h.description ? `<div class="habit-desc">${escHtml(h.description)}</div>` : ''}
        </div>
        ${checked ? '<span class="habit-tag">âœ“ å·²å®Œæˆ</span>' : ''}
      </div>`;
  }).join('');

  progressText.textContent = `${checkedCount}/${activeHabits.length}`;
  updateRing(checkedCount, activeHabits.length);
}

function updateRing(done, total) {
  const circumference = 106.8;
  const pct = total > 0 ? done / total : 0;
  const offset = circumference * (1 - pct);
  document.getElementById('ring-fill').style.strokeDashoffset = offset;
  document.getElementById('ring-pct').textContent = total > 0 ? Math.round(pct * 100) + '%' : 'â€”';
  document.getElementById('ring-fill').style.stroke =
    pct === 1 ? 'var(--success)' : 'var(--primary)';
}

function handleCheck(habitId) {
  const today = todayStr();
  toggleCheck(today, habitId);
  renderToday();
  renderWeekStats();
  const checked = isChecked(today, habitId);
  const h = habits.find(x => x.id === habitId);
  if (checked) {
    const msgs = [
      `${h.icon} "${h.name}" æ‰“å¡æˆåŠŸï¼åŠ æ²¹ï¼`,
      `${h.icon} æ£’æ£’çš„ï¼"${h.name}" å®Œæˆå•¦ï½`,
      `${h.icon} åšæŒå°±æ˜¯èƒœåˆ©ï¼"${h.name}" âœ“`,
    ];
    showToast(msgs[Math.floor(Math.random() * msgs.length)]);
  }
}

/* ============================================================
   Render: Weekly Stats
   ============================================================ */
function renderWeekStats() {
  const weekDates = getWeekDates();
  const today = todayStr();
  const activeHabits = habits.filter(h => !h.archivedAt);

  // 7-day dot grid
  const grid = document.getElementById('week-grid');
  grid.innerHTML = weekDates.map((dateStr, i) => {
    const d = new Date(dateStr + 'T00:00:00');
    const dayNum = d.getDate();
    const isFuture = dateStr > today;
    const isToday  = dateStr === today;

    let dotClass = '';
    if (!isFuture && activeHabits.length > 0) {
      const checkedN = activeHabits.filter(h => isChecked(dateStr, h.id)).length;
      if (checkedN === activeHabits.length) dotClass = 'full';
      else if (checkedN > 0) dotClass = 'partial';
    }
    if (isFuture) dotClass = 'future';
    if (isToday)  dotClass += ' today';

    return `
      <div class="week-day">
        <div class="week-day-label">${DAY_LABELS[(i+1)%7]}</div>
        <div class="week-day-dot ${dotClass}" title="${dateStr}">${dayNum}</div>
      </div>`;
  }).join('');

  // Summary banner
  const pastDates = weekDates.filter(d => d <= today);
  let totalPossible = pastDates.length * activeHabits.length;
  let totalChecked  = 0;
  pastDates.forEach(d => {
    activeHabits.forEach(h => { if (isChecked(d, h.id)) totalChecked++; });
  });

  const pct = totalPossible > 0 ? Math.round(totalChecked / totalPossible * 100) : 0;
  const emoji = pct === 100 ? 'ğŸ†' : pct >= 80 ? 'ğŸ”¥' : pct >= 50 ? 'ğŸ’ª' : pct > 0 ? 'ğŸŒ±' : 'ğŸŒ¸';
  document.getElementById('week-emoji').textContent = emoji;
  document.getElementById('week-summary-title').textContent =
    pct === 100 ? 'æœ¬å‘¨å…¨å‹¤ï¼è¶…çº§å¦ˆå¦ˆï¼' :
    pct >= 80   ? 'æœ¬å‘¨è¡¨ç°ä¼˜ç§€ï¼Œç»§ç»­åŠ æ²¹ï¼' :
    pct >= 50   ? 'å·²å®Œæˆä¸€åŠï¼Œä½ å¾ˆæ£’ï¼' :
    pct > 0     ? 'å·²ç»å¼€å§‹äº†ï¼ŒåšæŒä¸‹å»ï¼' : 'æœ¬å‘¨è¿˜æ²¡æœ‰æ‰“å¡è®°å½•';
  document.getElementById('week-summary-sub').textContent =
    totalPossible > 0
      ? `æœ¬å‘¨å®Œæˆç‡ ${pct}%ï¼ˆ${totalChecked} / ${totalPossible} æ¬¡ï¼‰`
      : 'æ·»åŠ è‚²å„¿ä¹ æƒ¯åå¼€å§‹æ‰“å¡å§ ğŸŒ¸';

  // Per-habit progress bars
  const statsEl = document.getElementById('habit-stats');
  if (activeHabits.length === 0) {
    statsEl.innerHTML = '<p style="color:var(--text-3);font-size:.85rem;text-align:center;padding:8px 0;">æš‚æ— ä¹ æƒ¯æ•°æ®</p>';
    return;
  }

  statsEl.innerHTML = activeHabits.map(h => {
    const done = pastDates.filter(d => isChecked(d, h.id)).length;
    const total = pastDates.length;
    const p = total > 0 ? Math.round(done / total * 100) : 0;
    return `
      <div class="stat-row">
        <div class="stat-row-header">
          <div class="stat-habit-name">
            <span>${h.icon}</span>
            <span>${escHtml(h.name)}</span>
          </div>
          <div class="stat-pct">${done}/${total}&nbsp;&nbsp;${p}%</div>
        </div>
        <div class="progress-track">
          <div class="progress-fill ${p===100?'full':''}"
               style="width:${p}%; background:${p===100?'var(--success)':h.color}"></div>
        </div>
      </div>`;
  }).join('');
}

/* ============================================================
   Render: Manage List
   ============================================================ */
function renderManageList() {
  const list = document.getElementById('manage-habit-list');
  const activeHabits = habits.filter(h => !h.archivedAt);

  if (activeHabits.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="emoji">ğŸŒ¸</div>
        <p>ç‚¹å‡»ã€Œæ·»åŠ ä¹ æƒ¯ã€åˆ›å»ºè‚²å„¿æ‰“å¡é¡¹ç›®</p>
      </div>`;
    return;
  }

  list.innerHTML = activeHabits.map(h => `
    <div class="habit-item" style="cursor:default;">
      <div class="habit-icon-wrap" style="background:${hexToRgba(h.color,.15)}">${h.icon}</div>
      <div class="habit-info">
        <div class="habit-name">${escHtml(h.name)}</div>
        ${h.description ? `<div class="habit-desc">${escHtml(h.description)}</div>` : ''}
      </div>
      <div class="habit-actions">
        <button class="btn-icon danger" title="åˆ é™¤" onclick="archiveHabit('${h.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}

/* ============================================================
   Add Habit Form
   ============================================================ */
function toggleAddForm() {
  const wrap = document.getElementById('add-form-wrap');
  const isHidden = wrap.style.display === 'none';
  wrap.style.display = isHidden ? 'block' : 'none';
  const btn = document.getElementById('toggle-add-btn');
  document.getElementById('toggle-add-icon').textContent = isHidden ? 'âœ•' : 'ï¼‹';
  btn.childNodes[1].textContent = isHidden ? '\u00a0æ”¶èµ·' : '\u00a0æ·»åŠ ä¹ æƒ¯';
  if (isHidden) document.getElementById('f-name').focus();
}

function cancelAddForm() {
  document.getElementById('add-form-wrap').style.display = 'none';
  document.getElementById('toggle-add-icon').textContent = 'ï¼‹';
  document.getElementById('toggle-add-btn').childNodes[1].textContent = '\u00a0æ·»åŠ ä¹ æƒ¯';
  resetForm();
}

function resetForm() {
  document.getElementById('f-name').value = '';
  document.getElementById('f-desc').value = '';
  selectedIcon  = ICONS[0];
  selectedColor = COLORS[0];
  renderIconPicker();
  renderColorPicker();
}

function saveHabit() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { showToast('è¯·è¾“å…¥ä¹ æƒ¯åç§° ğŸŒ¸'); return; }

  const newHabit = {
    id: 'h' + Date.now(),
    name,
    description: document.getElementById('f-desc').value.trim(),
    icon: selectedIcon,
    color: selectedColor,
    frequency: 'daily',
    targetDays: ['mon','tue','wed','thu','fri','sat','sun'],
    createdAt: todayStr(),
    archivedAt: null,
    sortOrder: habits.length + 1
  };

  habits.push(newHabit);
  saveHabits();
  cancelAddForm();
  renderAll();
  showToast(`${newHabit.icon} "${newHabit.name}" å·²æ·»åŠ ï¼`);
}

function archiveHabit(id) {
  const h = habits.find(x => x.id === id);
  if (!h) return;
  if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€Œ${h.name}ã€å—ï¼Ÿ\nå†å²æ‰“å¡è®°å½•å°†ä¿ç•™ã€‚`)) return;
  h.archivedAt = todayStr();
  saveHabits();
  renderAll();
  showToast(`ã€Œ${h.name}ã€å·²åˆ é™¤`);
}

/* ============================================================
   Icon & Color Pickers
   ============================================================ */
function renderIconPicker() {
  document.getElementById('icon-picker').innerHTML = ICONS.map(ic => `
    <button class="icon-btn ${ic === selectedIcon ? 'selected' : ''}"
            onclick="selectIcon('${ic}')" type="button">${ic}</button>`).join('');
}

function renderColorPicker() {
  document.getElementById('color-picker').innerHTML = COLORS.map(c => `
    <div class="color-dot ${c === selectedColor ? 'selected' : ''}"
         style="background:${c}" onclick="selectColor('${c}')" title="${c}"></div>`).join('');
}

function selectIcon(ic) { selectedIcon = ic; renderIconPicker(); }
function selectColor(c) { selectedColor = c; renderColorPicker(); }

/* ============================================================
   Daily Tip
   ============================================================ */
function renderDailyTip() {
  const idx = new Date().getDate() % TIPS.length;
  document.getElementById('tip-text').textContent = TIPS[idx];
}

/* ============================================================
   Toast
   ============================================================ */
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

/* ============================================================
   Utility
   ============================================================ */
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ============================================================
   Header Date
   ============================================================ */
function renderHeaderDate() {
  const d = new Date();
  const weekNames = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
  document.getElementById('header-date').textContent =
    `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥  ${weekNames[d.getDay()]}`;
}

/* ============================================================
   Render All
   ============================================================ */
function renderAll() {
  renderToday();
  renderWeekStats();
  renderManageList();
}

/* ============================================================
   Default Habits â€” 0~1å²æ–°æ‰‹å¦ˆå¦ˆ
   ============================================================ */
const DEFAULT_HABITS = [
  // å®å®æŠ¤ç†
  { name:'å–‚å¥¶è®°å½•',    description:'æŒ‰éœ€å“ºä¹³ï¼Œè®°å½•æ¯æ¬¡å–‚å¥¶æ—¶é—´',  icon:'ğŸ¼', color:'#E8735A', cat:'å®å®æŠ¤ç†' },
  { name:'æ¢å°¿å¸ƒ',      description:'ä¿æŒå®å®å¹²çˆ½ï¼Œé¢„é˜²å°¿å¸ƒç–¹',    icon:'ğŸ§·', color:'#F4A261', cat:'å®å®æŠ¤ç†' },
  { name:'å®å®æ´—æ¾¡',    description:'37~38â„ƒæ¸©æ°´ï¼Œæ¯æ¬¡5~10åˆ†é’Ÿ',   icon:'ğŸ›', color:'#45B7D1', cat:'å®å®æŠ¤ç†' },
  { name:'å®å®ç¡çœ ',    description:'è§‚å¯Ÿå¹¶è®°å½•å®å®ç¡çœ è§„å¾‹',      icon:'ğŸ˜´', color:'#DDA0DD', cat:'å®å®æŠ¤ç†' },
  // æ—©æ•™äº’åŠ¨
  { name:'äº²å­æŠšè§¦',    description:'æ¯å¤©10åˆ†é’ŸæŒ‰æ‘©ï¼Œä¿ƒè¿›ç¥ç»å‘è‚²', icon:'ğŸ¤±', color:'#96CEB4', cat:'æ—©æ•™äº’åŠ¨' },
  { name:'äº²å­äº’åŠ¨',    description:'å’Œå®å®è¯´è¯ã€å”±æ­Œã€è¯»ç»˜æœ¬',    icon:'ğŸ—£ï¸', color:'#4ECDC4', cat:'æ—©æ•™äº’åŠ¨' },
  { name:'æˆ·å¤–æ•£æ­¥',    description:'æ¨è½¦å‡ºé—¨æ™’å¤ªé˜³ï¼Œå‘¼å¸æ–°é²œç©ºæ°”', icon:'ğŸŒ¿', color:'#52B788', cat:'æ—©æ•™äº’åŠ¨' },
  { name:'æˆé•¿è®°å½•',    description:'æ‹ç…§æˆ–å†™æ—¥è®°è®°å½•å®å®æˆé•¿',    icon:'ğŸ“¸', color:'#F7DC6F', cat:'æ—©æ•™äº’åŠ¨' },
  // å¦ˆå¦ˆè‡ªæˆ‘ç…§é¡¾
  { name:'å¦ˆå¦ˆè¡¥æ°´',    description:'å“ºä¹³æœŸæ¯å¤©å–è¶³2000mlæ°´',      icon:'ğŸ’§', color:'#45B7D1', cat:'å¦ˆå¦ˆæŠ¤ç†' },
  { name:'å¦ˆå¦ˆä¼‘æ¯',    description:'è¶å®å®ç¡è§‰æ—¶è¡¥å……ç¡çœ ',        icon:'ğŸŒ™', color:'#DDA0DD', cat:'å¦ˆå¦ˆæŠ¤ç†' },
];

/* ============================================================
   Init
   ============================================================ */
function init() {
  loadHabits();
  renderHeaderDate();
  renderIconPicker();
  renderColorPicker();
  renderDailyTip();
  renderAll();

  if (habits.length === 0) {
    DEFAULT_HABITS.forEach((d, i) => {
      habits.push({
        id: 'h_default_' + i,
        name: d.name,
        description: d.description,
        icon: d.icon,
        color: d.color,
        frequency: 'daily',
        targetDays: ['mon','tue','wed','thu','fri','sat','sun'],
        createdAt: todayStr(),
        archivedAt: null,
        sortOrder: i + 1
      });
    });
    saveHabits();
    renderAll();
    showToast('ğŸŒ¸ å·²ä¸ºæ–°æ‰‹å¦ˆå¦ˆåˆ›å»ºè‚²å„¿æ‰“å¡æ¸…å•ï¼');
  }
}

init();
</script>
</body>
</html>